define(['ko','jquery','uiComponent','Magento_Customer/js/customer-data','Magento_Ui/js/modal/modal','Lindt_Laya/js/model/full-screen-loader','mage/storage','Lindt_Laya/js/model/url-builder','mage/translate'],function(ko,$,Component,customerData,modal,fullScreenLoader,storage,urlBuilder,$t){'use strict';return Component.extend({modalId:'#lindt-laya-loyalty-tc-overlay',modalElement:'',canShow:ko.observable(false),logoutUrl:ko.observable(''),customerId:ko.observable(0),popupContent:ko.observable(''),success:false,errorMessage:ko.observable(''),acceptLayaBtn:'.accept-laya',initialize:function(){this._super();customerData.reload(['laya-tc-overlay-section'],true);customerData.get('laya-tc-overlay-section').subscribe(function(updated){this.canShow(updated.canShow);this.popupContent(updated.canShow?updated.popupContent:'');this.customerId(updated.customerId);this.logoutUrl(updated.logoutUrl);if(this.canShow()){this.modalElement=$(this.modalId);this.showTcPopup();}},this);},showTcPopup:function(){var self=this;var options={type:'popup',modalClass:'modal-popup--laya',responsive:true,innerScroll:false,title:false,backdrop:'static',keyboard:false,closeOnEscape:false,clickableOverlay:false,modalCloseBtnHandler:this.onClosePopUp.bind(this),buttons:[{text:$.mage.__('Accept'),class:'action primary accept-laya',click:function(){self.acceptLayaOverlay();}},{text:$.mage.__('Decline '),class:'action-dismiss decline-laya',click:function(){self.declineLayaOverlay();}}]};modal(options,this.modalElement);this.modalElement.modal('openModal');this.modalElement.on('modalopened',function(){self.resizePopup();$(window).resize(function(){self.resizePopup();})});},resizePopup:function(){var windowHeight=$(window).height(),otherElementsHeight=365,modalTopHeight=$('.modal-popup--laya__top').height();$('.modal-popup--laya__scrollable').height(windowHeight-otherElementsHeight-modalTopHeight);},onClosePopUp:function(){if(this.success===false){this.declineLayaOverlay();}},acceptLayaOverlay:function(){var self=this;var payload={layaRegSource:'webshop',customer:null,customerId:parseInt(self.customerId()),};fullScreenLoader.startLoader();$(self.acceptLayaBtn).attr('disabled','disabled');return storage.post(urlBuilder.createUrl('/laya/api/create-customer',{}),JSON.stringify(payload)).done(function(response){if(response){self.success=true;}
fullScreenLoader.stopLoader();self.modalElement.modal('closeModal');window.location.reload();}).fail(function(response){self.success=false;var responseJson=response.responseJSON;var errorMessage=responseJson.message?responseJson.message:$t('An error occurred. Please try again later or contact us');self.errorMessage(errorMessage);setTimeout(()=>{self.modalElement.modal('closeModal');fullScreenLoader.stopLoader();},3000);});},declineLayaOverlay:function(){var self=this;fullScreenLoader.startLoader();self.errorMessage($t('You will be logged out, because you did not accept our T&C.'));setTimeout(()=>{window.location.href=self.logoutUrl();fullScreenLoader.stopLoader();},3000);},});});